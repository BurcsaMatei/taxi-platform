name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - "pages/**"
      - "components/**"
      - "lib/**"
      - "styles/**"
      - "public/**"
      - "scripts/**"
      - "next.config.*"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "pages/**"
      - "components/**"
      - "lib/**"
      - "styles/**"
      - "public/**"
      - "scripts/**"
      - "next.config.*"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/ci.yml"

# Evită rulări paralele pe același branch (ultimul push anulează run-urile anterioare)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  NEXT_TELEMETRY_DISABLED: "1"
  # Asigură un fallback dacă variabila nu e setată în repo/secret
  NEXT_PUBLIC_SITE_URL: "https://konceptid.com"
  CI: "true"

jobs:
  # 1) Lint (dacă ai script lint)
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint
        # rulează doar dacă există scriptul în package.json
        run: npm run lint --if-present

  # 2) TypeScript type-check
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Type check
        run: npm run type-check

  # 3) Teste (dacă ai jest/vitest configurat)
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run tests (if present)
        run: npm test --if-present

  # 4) Build — depinde de verificările anterioare
  build:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      # Cache pentru .next/cache (ajută build-urile repetate)
      - name: Cache Next.js build cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('next.config.*', 'tsconfig.json', 'pages/**/*', 'components/**/*', 'lib/**/*', 'styles/**/*') }}
          restore-keys: |
            next-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}-
            next-${{ env.NODE_VERSION }}-

      # Dacă ai script de generare galerie, rulează-l înainte de build
      - name: Build gallery data
        run: npm run gallery:build

      - name: Build Next.js
        run: npm run build

      # Dacă ai script postbuild (RSS etc.), se va executa automat.
      # Poți încărca artefacte utile pentru debugging (opțional):
      - name: Upload feed.xml (optional)
        if: hashFiles('public/feed.xml') != ''
        uses: actions/upload-artifact@v4
        with:
          name: feed.xml
          path: public/feed.xml

      - name: Upload build logs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: next-cache
          path: .next/cache
